[tools]
rust = "1.90"
go = "1.25.1"
python = "3.13"

[env]
# see also: https://mise.jdx.dev/templates.html
WORK_DIR = "/mnt/slate/bench"       # 2TB required, minimum 1.6TB, for 8M entries prove
DATA_SIZE = "{{ 8 * 1024 * 1024 }}" # 16GB memory required
DATA_SIZE_LARGE = "{{ 2 * 1024 * 1024 * 1024 }}"  # 1.4TB required, for 8MB entries get
TIMEOUT_SECONDS = "{{ 60 * 60 }}"
# WORK_DIR = "/tmp"
# DATA_SIZE = "{{ 256 }}"
# DATA_SIZE_LARGE = "{{ 65536 }}"
# TIMEOUT_SECONDS = "{{ 5 * 60 }}"
PROJECT_ROOT = "{{config_root}}"
RESULTS_DIR = "{{config_root}}/results"
COMMIT = "{{ exec(command='git rev-parse --short HEAD') }}"

[settings]  
task_output = "interleave" # 2 ã¤ä»¥ä¸Šã®ä¾å­˜ã‚’è¨­å®šã™ã‚‹ã¨ prefix ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Š ProgressBar ãŒè¡¨ç¤ºã•ã‚Œãªããªã‚‹

[tasks.setup]
description = "Setup all project dependencies"
depends = ["setup:go", "setup:rust", "setup:python"]
run = [
  "mkdir -p $RESULTS_DIR",
]

[tasks.clean]
description = "Clean all build artifacts and results"
depends = ["clean:*"]
run = ["rm -rf $RESULTS_DIR/*", "rm -f *.png"]

[tasks.build]
depends = ["build:*"]

[tasks.bench]
description = "Run benchmark"
depends = ["build:*"]
run = [
  # When specified as depends, they are executed in parallel, but must be executed sequentially to
  # measure performance.
  "{{mise_bin}} run bench:info",
  "{{mise_bin}} run bench:rust",
  "{{mise_bin}} run bench:go",
]

[tasks.fmt]
description = "Format source"
depends = ["fmt:*"]

# -- Python ---

[tasks."setup:python"]
dir = "scripts"
run = [
  "pip install --upgrade pip",
  "python -m pip install -r requirements.txt",
]

[tasks."bench:info"]
run = [
  "python bench_info.py \"$WORK_DIR\"",
]

# --- Golang ---

[tasks."clean:go"]
description = "Clean Go build artifacts and results"
dir = "golang"
run = [
  "./iavl/iavl --clean && go mod tidy && go clean",
  "go clean -modcache -cache -testcache",
]

[tasks."fmt:go"]
description = "Clean Go build artifacts and results"
dir = "golang"
run = ["go mod tidy && go fmt slate_benchmark/common slate_benchmark/iavl slate_benchmark/doltdb"]

[tasks."setup:go"]
description = "Setup Go project dependencies"
dir = "golang"
run = [
  "sudo apt install -y llvm-dev libclang-dev clang",
  "go get slate_benchmark/common",
  "go get slate_benchmark/doltdb",
  "go get slate_benchmark/iavl",
  "go mod download",
  "go mod tidy",
]

[tasks."build:go"]
depends = ["setup:go"]
sources = ["golang/**/*.go", "golang/go.mod"]
outputs = ["golang/bench"]
dir = "golang"
run = ["go build -trimpath -o bench main.go"]

[tasks."bench:go"]
description = "Run Go benchmarks"
env.IAVL_DATA_SIZE = "{% if env.DATA_SIZE | int > 1024 * 1024 %}{{ 1024 * 1024 }}{% else %}{{ env.DATA_SIZE | default(value='1048576') }}{% endif %}"
depends = ["build:go"]
run = [
  "golang/bench $IAVL_DATA_SIZE --dir \"$WORK_DIR\" --timeout ${TIMEOUT_SECONDS}s --output \"$RESULTS_DIR\"",
]

# --- Rust Projects ---

[tasks."setup:rust"]

[tasks."clean:rust"]
dir = "rust"
run = ["target/release/slate_benchmark --clean && cargo clean"]

[tasks."fmt:rust"]
dir = "rust"
run = "cargo fmt"

[tasks."build:rust"]
description = "Build benchmark for Rust"
depends = ["fmt:rust", "setup:rust"]
sources = ["rust/src/**/*.rs", "rust/benches/**/*.rs", "rust/Cargo.toml"]
outputs = ["target/release/slate_benchmark"]
run = [
  "cargo build --release"
]

[tasks."bench:rust"]
description = "Run benchmark"
depends = ["build:rust"]
run = [
  # prove test in rocksdb needs to open a large number of files
  "ulimit -n 20480 && target/release/slate_benchmark $DATA_SIZE $DATA_SIZE_LARGE --dir \"$WORK_DIR\" --timeout $TIMEOUT_SECONDS --output \"$RESULTS_DIR\""
]

# --- Graph ---

[tasks."graph:experiments"]
run = ["./run.sh"]

[tasks."graph:io-read"]
run = ["cd scripts && python hamming-weight.py 11"]

# --- Environment Dependency ---

[tasks."setup:matplotlib"]
run = [
  '''
  echo 'ðŸŽ¸ Installing LaTeX...'
  sudo apt-get update
  sudo apt install -y texlive-xetex texlive-lang-japanese texlive-fonts-extra dvipng
  sudo apt install -y smartmontools fio
  ''',

  '''
  echo 'ðŸ§ Installing fonts on Linux...'
  USER_FONT_DIR="${HOME}/.local/share/fonts"
  mkdir -p "$USER_FONT_DIR"
  cp scripts/NeueHaasDisplay-Roman.ttf "$USER_FONT_DIR"
  echo "ðŸ”„ Updating font cache..."
  sudo fc-cache -fv >/dev/null 2>&1
  fc-cache -fv >/dev/null 2>&1
  echo "âœ… Linux font installation complete: $(fc-list 'Neue Haas Grotesk Display Pro')"
  ''',
]
