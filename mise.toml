[tools]
rust = "1.89"
go = "1.21"
python = "3.13"

[env]
# see also: https://mise.jdx.dev/templates.html
DATA_SIZE = "{{ 256 }}"
PROJECT_ROOT = "{{config_root}}"
RESULTS_DIR = "{{config_root}}/results"
WORK_DIR = "/tmp"
COMMIT = "{{ exec(command='git rev-parse --short HEAD') }}"

[tasks.setup]
description = "Setup all project dependencies"
depends = ["setup:*", "{{ os() }}:setup"]

[tasks.clean]
description = "Clean all build artifacts and results"
depends = ["clean:*"]
run = ["rm -rf $RESULTS_DIR/*", "rm -f *.png"]

[tasks.build]
depends = ["build:*"]

[tasks.bench]
description = "Run benchmark"
run = [
  # When specified as depends, they are executed in parallel, but must be executed sequentially to
  # measure performance.
  "{{mise_bin}} run bench:info",
  "{{mise_bin}} run bench:go",
  "{{mise_bin}} run bench:rust",
]

[tasks.fmt]
description = "Format source"
depends = ["fmt:*"]

# -- Python ---

[tasks."setup:python"]
run = ["cd python && python -m pip install -r scripts/requirements.txt"]

# --- Golang ---

[tasks."clean:go"]
description = "Clean Go build artifacts and results"
dir = "golang"
run = ["./iavl/iavl --clean && go mod tidy && go clean"]

[tasks."fmt:go"]
description = "Clean Go build artifacts and results"
dir = "golang"
run = ["go mod tidy && go fmt mt_bench/common mt_bench/iavl mt_bench/doltdb"]

[tasks."setup:go"]
description = "Setup Go project dependencies"
dir = "golang"
run = ["go mod download"]

[tasks."build:iavl"]
depends = ["setup:go"]
sources = ["golang/iavl/**/*.go", "golang/common/**/*.go", "golang/go.mod"]
outputs = ["golang/iavl/iavl"]
dir = "golang"
run = ["go build -trimpath -o iavl/iavl iavl/main.go"]

[tasks."build:doltdb"]
depends = ["setup:go"]
sources = ["golang/doltdb/main.go", "golang/common/**/*.go", "golang/go.mod"]
outputs = ["golang/doltdb/doltdb"]
dir = "golang"
run = ["go build -trimpath -o doltdb/doltdb doltdb/main.go"]

[tasks."bench:go"]
description = "Run Go benchmarks"
env.IAVL_DATA_SIZE = "{% if env.DATA_SIZE | int > 1024 * 1024 %}{{ 1024 * 1024 }}{% else %}{{ env.DATA_SIZE | default(value='1048576') }}{% endif %}"
depends = ["build:iavl", "build:doltdb"]
run = [
  "golang/iavl/iavl $IAVL_DATA_SIZE --dir \"$WORK_DIR\" --output \"$RESULTS_DIR\"",
  "golang/doltdb/doltdb $IAVL_DATA_SIZE --dir \"$WORK_DIR\" --output \"$RESULTS_DIR\"",
]

# --- Rust Projects ---

[tasks."setup:rust"]

[tasks."clean:rust"]
run = ["cd rust && target/release/slate_benchmark --clean && cargo clean"]

[tasks."fmt:rust"]
run = "cd rust && cargo fmt"

[tasks."build:rust"]
description = "Build benchmark for Rust"
depends = ["setup:rust"]
sources = ["rust/src/**/*.rs", "rust/benches/**/*.rs", "rust/Cargo.toml"]
outputs = ["target/release/slate_benchmark"]
run = "cargo build --release"

[tasks."bench:rust"]
description = "Run benchmark"
depends = ["build:rust"]
run = "target/release/slate_benchmark $DATA_SIZE --dir \"$WORK_DIR\" --output \"$RESULTS_DIR\""

# --- Graph ---

[tasks."graph:experiments"]
run = ["./run.sh"]

[tasks."graph:io-read"]
run = ["cd scripts && python hamming-weight.py 11"]

# --- Environment Dependency ---

[tasks."bench:info"]
run = ["python bench_info.py \"$WORK_DIR\""]

[tasks."linux:setup"]
run = [
  "mkdir -p $RESULTS_DIR",

  '''
  echo 'ðŸŽ¸ Installing LaTeX...'
  sudo apt-get update
  sudo apt -y install texlive-xetex texlive-lang-japanese texlive-fonts-extra dvipng
  sudo apt -y install smartmontools fio
  ''',

  '''
  echo 'ðŸ§ Installing fonts on Linux...'
  USER_FONT_DIR="${HOME}/.local/share/fonts"
  mkdir -p "$USER_FONT_DIR"
  cp scripts/NeueHaasDisplay-Roman.ttf "$USER_FONT_DIR"
  echo "ðŸ”„ Updating font cache..."
  sudo fc-cache -fv >/dev/null 2>&1
  fc-cache -fv >/dev/null 2>&1
  echo "âœ… Linux font installation complete: $(fc-list 'Neue Haas Grotesk Display Pro')"
  ''',
]
