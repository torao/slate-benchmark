[tools]
rust = "1.89"
go = "1.21"
python = "3.13"

[env]
# see also: https://mise.jdx.dev/templates.html
PROJECT_ROOT = "{{config_root}}"
RESULTS_DIR = "{{config_root}}/results"
WORK_DIR = "/tmp"
SESSION_ID = "{{ now() | date(format='%Y%m%d%H%M%S') }}"

[tasks.setup]
description = "Setup all project dependencies"
depends = ["setup:*"]
run = [
  "mkdir -p $RESULTS_DIR",
  "python -m pip install -r scripts/requirements.txt",
]

[tasks.clean]
description = "Clean all build artifacts and results"
depends = ["clean:*"]
run = [
  "cargo clean",
  "rm -rf $RESULTS_DIR/*",
  "rm -f *.png",
]

[tasks.build]
depends = ["build:*"]

# --- Go Projects ---

[tasks."clean:go"]
description = "Clean Go build artifacts and results"
run = [
  "cd iavl && ./iavl --clean && go clean",
]

[tasks."setup:go"]
description = "Setup Go project dependencies"
run = [
  "cd iavl && go mod download",
]

[tasks."build:go"]
description = "Build benchmark for Go"
depends = ["setup:go"]
sources = ["iavl/main.go", "go.mod"]
outputs = ["iavl/iavl"]
run = ["cd iavl && go build -trimpath -o iavl main.go"]

[tasks."bench:go"]
description = "Run Go benchmarks"
depends = ["build:go"]
run = ["cd iavl && ./iavl \"$WORK_DIR\" --output \"$RESULTS_DIR\" --session \"$SESSION_ID\""]

# --- Rust Projects ---

[tasks.build-rust]
description = "Build benchmark for Rust"
run = "cargo build --release"

[tasks.run]
description = "Run benchmark"
depends = ["build"]
run = "target\\release\\slate_benchmark.exe"

[tasks.fmt]
description = "Format source"
run = ["cd iavl && go fmt", "cargo fmt"]

[tasks.setup-linux]
depends = ["setup-linux-fonts"]

[tasks.setup-linux-fonts]
description = "グラフ描画に使用するフォントをインストール"
run = '''
echo "🐧 Linux にフォントをインストール中..."
USER_FONT_DIR="${HOME}/.local/share/fonts"
mkdir -p $USER_FONT_DIR
cp scripts/NeueHaasDisplay-Roman.ttf $USER_FONT_DIR

echo "🔄 フォントキャッシュを更新中..."
sudo fc-cache -fv >/dev/null 2>&1
fc-cache -fv >/dev/null 2>&1

echo "✅ Linux フォントインストール完了: $(fc-list 'Neue Haas Grotesk Display Pro')"
'''
